external_components:
  - source:
      type: git
      url: https://github.com/Evka2k/esphome_external_components.git
      ref: main
    components: [ eg1155 ]

substitutions:
  name: eg1155
  description: "Control and monitor EG1155 battery charge controller via UART" 

esphome:
  name: ${name}
  comment: ${description}

esp32:
  board: esp32dev
  framework:
    type: esp-idf

# Enable logging
logger:
  level: INFO

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  networks:
    - ssid: !secret wifi_ssid
      password: !secret wifi_password

# Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${name} Fallback Hotspot"
    password: !secret fallback_ap_password

captive_portal:

web_server:
  port: 80
  version: 3
  sorting_groups:
    - id: sensors
      name: "Sensors"
      sorting_weight: 10
    - id: controls
      name: "Controls"
      sorting_weight: 20

uart:
  - id: uart_bus1
    baud_rate: 9600
    data_bits: 8
    stop_bits: 1
    parity: NONE  
    tx_pin: GPIO17
    rx_pin: GPIO16

eg1155:
  uart_id: uart_bus1

sensor:
  - platform: eg1155
    temperature_mos:
      name: "Temperature MOS"
      web_server:
        sorting_group_id: sensors
    temperature_env:
      name: "Temperature ENV"
      web_server:
        sorting_group_id: sensors
    voltage:
      name: "Voltage"
      web_server:
        sorting_group_id: sensors
    battery_voltage:
      name: "Battery Voltage"
      web_server:
        sorting_group_id: sensors
    current:
      name: "Current"
      web_server:
        sorting_group_id: sensors
    capacity:
      name: "Charged Capacity"
      web_server:
        sorting_group_id: sensors
    ch_state:
      name: "Charging state"
      web_server:
        sorting_group_id: sensors
    b_progress:
      name: "Battery progress"
      web_server:
        sorting_group_id: sensors

number:
  - platform: eg1155
    set_voltage:
      name: "SetVoltage"
      min_value: 10
      max_value: 93
      step: 0.01
      web_server:
        sorting_group_id: controls
    set_current:
      name: "SetCurrent"
      min_value: 1
      max_value: 20
      step: 0.01
      web_server:
        sorting_group_id: controls

button:
  - platform: eg1155
    savebutton:
      name: "SaveSettings"
      web_server:
        sorting_group_id: controls

switch:
  - platform: eg1155
    onoff:
      name: "On/Off"
      web_server:
        sorting_group_id: controls
